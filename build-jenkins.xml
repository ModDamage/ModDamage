<project name="Jenkins-BukkitPlugin" default="clean">
	
<!-- START PREDEFINED -->
	<property environment="env"/>
	<property name="sourceFolder" location="src"/>
	<property name="buildFolder" location="bin"/>
	<property name="webBuildFolder" location="bin/web"/>
	<property name="dependencyFolder" location="resource"/>
<!-- END PREDEFINED -->	
	
	<target name="init">
		<tstamp/>
	    <mkdir dir="${buildFolder}"/>
	    <mkdir dir="${webBuildFolder}"/>
	</target>

	<target name="compile" depends="init" description="Compile class files">
		<echo message="Compiling source into ${buildFolder}..."/>
		<path id="project.classpath">
	        <fileset dir="${dependencyFolder}">
	            <include name="*.jar"/>
	        </fileset>
	    </path>
		<javac srcdir="${sourceFolder}" destdir="${buildFolder}" verbose="true" listfiles="true" classpathref="project.classpath" source="1.6" target="1.6" debug="on" includeantruntime="false" />
		

		<echo>Copying webserver files for compiling...</echo>
		
		<copy todir="${webBuildFolder}" overwrite="true" verbose="true">
			<fileset dir="web">
				<include name="bootstrap/**/*.*" />
				<include name="js/*.js" />
				<include name="views/*.*" />
				<include name="*.*" />
				<include name="bower_components/ace-builds/src-*noconflict/ace.js" />
				<include name="bower_components/angular*/angular*.min.js" />
				<include name="bower_components/angular*/*.css" />
				<include name="**/bower.json" />
				<include name="bower_components/angular*/angular*.min.js" />
				<include name="bower_components/jquery/jquery*.*" />
				<include name="bower_components/angular-ui-bootstrap/src/**/*.js" />
				<include name="bower_components/angular-ui*/*.js" />
				<include name="bower_components/lodash/dist/*.js" />
				<include name="bower_components/bootstrap/dist/**/*.*" />
				
				<!-- 
					Don't include readmes or demos. We know what the api we use does.
					Also Don't include grunt files (Api builders)
					Just include licenses just in case some require a license to be copied over.
				-->
				<exclude name="**/Gruntfile.js" />
				<exclude name="**/*README*" />
				<exclude name="**/*demo*.*" />
				<exclude name="**/*TEST*" />
				<include name="**/*LICENSE*" />
			</fileset>
		</copy>
		
		<replaceregexp flags="gm" match='(&lt;(?:link|script) (?:href|src)=")\.?(.*&gt;)' replace="\1/static\2">
			<fileset dir="${webBuildFolder}" includes="**/*.html"/>
		</replaceregexp>
				
		<replaceregexp flags="gm" match="(templateUrl: ')\.?(.*)'" replace="\1/static\2">
			<fileset dir="${webBuildFolder}" includes="**/app.js"/>
		</replaceregexp>
		
		<echo message="Web files compilation complete..."/>
	</target>

	<!-- Append Jenkins build number. -->
	<target name="addJenkinsBuild" depends="compile">
		<replaceregexp file="plugin.yml" match="^version: ([^ ]*)( DEV)$" replace="version: \1 build ${env.BUILD_NUMBER}" byline="true"/>
	</target>
	
	<!-- Slap the JAR together. -->
	<target name="jar" depends="addJenkinsBuild" description="Pack JAR file">
		<jar destfile="${env.JOB_NAME}.jar" update="no">
			<fileset dir="${buildFolder}" />
			<fileset dir="." includes="plugin.yml"/>
			<manifest>
				<attribute name="Job" value="${env.JOB_NAME}"/>
				<attribute name="Built-By" value="ModDamage Jenkins"/>
				<!-- <attribute name="Version" value="${version}"/> -->
				<attribute name="Build" value="${env.BUILD_NUMBER}"/> 
			</manifest>
		</jar>
	</target>

    <!-- Made the JAR, so get rid of the excess .class files. -->
	<target name="clean" depends="jar">
		<echo message="Deleting .class files..."/>
		<delete dir="${buildFolder}"/>
		<echo message="Deleting compiled files..."/>
		<delete dir="${webBuildFolder}"/>
	</target>
	
</project>
